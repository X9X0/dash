generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  role         String   @default("operator") // admin, operator, viewer
  createdAt    DateTime @default(now()) @map("created_at")

  reservations        Reservation[]
  jobs                Job[]
  activityLogs        ActivityLog[]
  maintenanceRequests MaintenanceRequest[]
  maintenanceUpdates  MaintenanceUpdate[]
  serviceRecords      ServiceRecord[]
  hourEntries         HourEntry[]
  notifications       Notification[]
  claimedMachines     Machine[]           @relation("MachineClaims")
  attachments         MachineAttachment[]

  @@map("users")
}

model MachineType {
  id           String  @id @default(cuid())
  name         String
  category     String  // robot, printer
  icon         String?
  fieldsSchema String? @map("fields_schema") // JSON string

  machines Machine[]

  @@map("machine_types")
}

model Machine {
  id               String    @id @default(cuid())
  name             String
  typeId           String    @map("type_id")
  model            String
  location         String
  status           String    @default("available") // available, in_use, maintenance, offline
  condition        String    @default("functional") // functional, degraded, broken
  conditionNote    String?   @map("condition_note")
  hourMeter        Float     @default(0) @map("hour_meter")
  buildDate        DateTime? @map("build_date")
  icon             String?
  notes            String?
  statusNote       String?   @map("status_note")
  autoHourTracking Boolean   @default(false) @map("auto_hour_tracking")
  lastPingAt       DateTime? @map("last_ping_at")
  claimedById      String?   @map("claimed_by_id")
  claimedAt        DateTime? @map("claimed_at")
  claimExpiresAt   DateTime? @map("claim_expires_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  type         MachineType          @relation(fields: [typeId], references: [id])
  claimedBy    User?                @relation("MachineClaims", fields: [claimedById], references: [id], onDelete: SetNull)
  ips          MachineIP[]
  customFields MachineCustomField[]
  statusLogs   MachineStatusLog[]
  reservations Reservation[]
  jobs         Job[]
  activityLogs ActivityLog[]
  maintenance  MaintenanceRequest[]
  serviceRecords ServiceRecord[]
  hourEntries  HourEntry[]
  attachments  MachineAttachment[]

  @@map("machines")
}

model MachineIP {
  id        String @id @default(cuid())
  machineId String @map("machine_id")
  label     String
  ipAddress String @map("ip_address")

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@map("machine_ips")
}

model MachineCustomField {
  id         String @id @default(cuid())
  machineId  String @map("machine_id")
  fieldName  String @map("field_name")
  fieldValue String @map("field_value")

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@map("machine_custom_fields")
}

model MachineStatusLog {
  id        String   @id @default(cuid())
  machineId String   @map("machine_id")
  status    String
  condition String?
  source    String   @default("manual") // manual, api
  timestamp DateTime @default(now())

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)

  @@map("machine_status_log")
}

model Reservation {
  id        String   @id @default(cuid())
  machineId String   @map("machine_id")
  userId    String   @map("user_id")
  startTime DateTime @map("start_time")
  endTime   DateTime @map("end_time")
  purpose   String
  status    String   @default("pending") // pending, confirmed, cancelled, completed
  createdAt DateTime @default(now()) @map("created_at")

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reservations")
}

model Job {
  id        String    @id @default(cuid())
  machineId String    @map("machine_id")
  userId    String    @map("user_id")
  name      String
  startTime DateTime? @map("start_time")
  endTime   DateTime? @map("end_time")
  status    String    @default("queued") // queued, running, completed, failed, cancelled
  notes     String?

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("jobs")
}

model ActivityLog {
  id        String   @id @default(cuid())
  machineId String   @map("machine_id")
  userId    String   @map("user_id")
  action    String
  details   String?
  timestamp DateTime @default(now())

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("activity_logs")
}

model MaintenanceRequest {
  id          String    @id @default(cuid())
  machineId   String    @map("machine_id")
  userId      String    @map("user_id")
  type        String    // damage, repair, upgrade
  priority    String    @default("medium") // low, medium, high, critical
  description String
  status      String    @default("submitted") // submitted, in_progress, resolved
  photos      String?   // JSON array of file paths
  createdAt   DateTime  @default(now()) @map("created_at")
  resolvedAt  DateTime? @map("resolved_at")

  machine Machine              @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  updates MaintenanceUpdate[]

  @@map("maintenance_requests")
}

model MaintenanceUpdate {
  id                   String   @id @default(cuid())
  maintenanceRequestId String   @map("maintenance_request_id")
  userId               String   @map("user_id")
  content              String
  photos               String?
  createdAt            DateTime @default(now()) @map("created_at")

  maintenanceRequest MaintenanceRequest @relation(fields: [maintenanceRequestId], references: [id], onDelete: Cascade)
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("maintenance_updates")
}

model ServiceRecord {
  id          String   @id @default(cuid())
  machineId   String   @map("machine_id")
  userId      String   @map("user_id")
  type        String   // repair, upgrade, modification, calibration
  description String
  partsUsed   String?  @map("parts_used")
  cost        Float?
  performedBy String   @map("performed_by")
  performedAt DateTime @map("performed_at")
  notes       String?
  photos      String?  // JSON array of file paths

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("service_records")
}

model HourEntry {
  id        String   @id @default(cuid())
  machineId String   @map("machine_id")
  userId    String   @map("user_id")
  hours     Float
  date      DateTime
  notes     String?

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("hour_entries")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  type      String
  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model MachineAttachment {
  id           String   @id @default(cuid())
  machineId    String   @map("machine_id")
  userId       String   @map("user_id")
  filename     String
  originalName String   @map("original_name")
  fileType     String   @map("file_type")
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")

  machine Machine @relation(fields: [machineId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("machine_attachments")
}
